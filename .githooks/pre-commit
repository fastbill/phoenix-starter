#!/bin/bash

# Phoenix pre-commit hook
# Runs code quality checks before allowing commits

echo "Running pre-commit checks..."

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.php$")

if [ -z "$STAGED_FILES" ]; then
    echo "No PHP files staged for commit."
    exit 0
fi

# Run PHP syntax check
echo "Checking PHP syntax..."
for FILE in $STAGED_FILES; do
    php -l "$FILE" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "Syntax error in: $FILE"
        exit 1
    fi
done

# Run PHP CS Fixer in dry-run mode
if [ -f "vendor/bin/php-cs-fixer" ]; then
    echo "Checking code style..."
    vendor/bin/php-cs-fixer fix --dry-run --diff --config=.php-cs-fixer.php $STAGED_FILES
    if [ $? -ne 0 ]; then
        echo ""
        echo "Code style issues found. Run 'composer cs:fix' to fix them."
        exit 1
    fi
fi

# Run PHPStan
if [ -f "vendor/bin/phpstan" ]; then
    echo "Running static analysis..."
    vendor/bin/phpstan analyse $STAGED_FILES --no-progress
    if [ $? -ne 0 ]; then
        echo ""
        echo "Static analysis found issues."
        exit 1
    fi
fi

echo "All pre-commit checks passed!"
exit 0